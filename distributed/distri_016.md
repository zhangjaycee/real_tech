# æ–‡ä»¶ç³»ç»Ÿçš„ä¸€è‡´æ€§é—®é¢˜ (crash consistency)

åœ¨å­˜å‚¨ç³»ç»Ÿä¸­éƒ½ä¼šå­˜åœ¨(æ•°æ®åº“ã€æ–‡ä»¶ç³»ç»Ÿã€dedupç³»ç»Ÿ ...)ï¼Œå³ç³»ç»Ÿé­é‡æ–­ç”µã€
å´©æºƒç­‰æƒ…å†µæ—¶ï¼Œç›¸å…³è”çš„æ•°æ®æ²¡æœ‰å…¨éƒ¨æŒä¹…åŒ–å¯¼è‡´çš„ä¸ä¸€è‡´ã€‚

æ ¹æœ¬åŸå› æ˜¯å­˜å‚¨ç³»ç»Ÿä¸­åº•å±‚çš„ä¸€æ¬¡I/Oï¼Œæ— æ³•ä¿è¯ä¸Šå±‚çš„ä¸€æ¬¡
è¯·æ±‚çš„ç›¸å…³è”çš„æ•°æ®çš„åŸå­å†™å…¥ï¼Œæ‰€ä»¥éœ€è¦ä¸Šå±‚çš„æœºåˆ¶ä¿è¯ä¸€
è‡´æ€§ã€‚ (~~ç›¸å…³è”çš„æ•°æ®ä¸€èˆ¬æŒ‡metadataå’Œdataï¼Œå¦‚æ–‡ä»¶ç³»ç»Ÿä¸­çš„inodeå’Œç”¨æˆ·æ•°æ®~~ï¼‰ 

| æ•°æ®å— | inodeå— |bitmapå—|ä¸€è‡´æ€§|å¤‡æ³¨|
|--------|--------|-------|----|---|
|N|N|N|ä¸€è‡´|ç›¸å½“äºä»€ä¹ˆä¹Ÿæ²¡å¹²ï¼ŒFSä¸€è‡´ï¼Œè™½ç„¶å†™æ²¡æœ‰æˆåŠŸ|
|N|N|F|ä¸ä¸€è‡´ï¼ˆbitmapå’Œå®é™…å ç”¨ç©ºé—´ï¼‰|è‹¥bitmapè®°å½•äº†åˆ†é…äº†æ–°ç©ºé—´ï¼Œå¯èƒ½å¯¼è‡´â€œç©ºé—´æ³„éœ²â€ï¼ˆé“ç†ç±»ä¼¼å†…å­˜æ³„æ¼ï¼‰ï¼Œ|
|N|F|N|ä¸ä¸€è‡´ï¼ˆinodeæŒ‡é’ˆå’Œå®é™…å­˜å‚¨ä½ç½®ï¼‰|è¿™æ—¶inodeæŒ‡å‘äº†å¹¶æœªæ›´æ–°çš„æ•°æ®å—ï¼Œåç»­çš„è¯»æ“ä½œä¼šè¿”å›ä¸€å †â€œåƒåœ¾â€æ•°æ®|
|N|F|F|ä¸ä¸€è‡´|åŒä¸Šï¼Œå¯èƒ½è¯»åˆ°â€œåƒåœ¾â€æ•°æ®|
|  F  |    N    |    N |ä¸€è‡´|è™½ç„¶å†™è¯·æ±‚æ²¡æœ‰æˆåŠŸï¼Œä½†å› ä¸ºbitmapå’Œinodeéƒ½æ²¡å˜ï¼Œå†™å…¥æ•°æ®å—åªæ˜¯ç›¸å½“äºç™½å†™äº†ï¼Œæ²¡æœ‰å¼•èµ·ä¸ä¸€è‡´|
|F|N|F|ä¸ä¸€è‡´|ç”±äºinodeæ²¡æœ‰æ›´æ–°ï¼Œå¯èƒ½è¯»ä¸åˆ°æ›´æ–°çš„æ•°æ®å—|
|F|F|N|ä¸ä¸€è‡´ï¼ˆbitmapç©ºé—²ç©ºé—´å’Œå®é™…æ‰€ç”¨ç©ºé—´ï¼‰|æœªæ›´æ–°çš„bitmapå¯èƒ½å¯¼è‡´å†æ¬¡ç”³è¯·æ—¶è¦†ç›–æœ‰æ•ˆæ•°æ®|
|F|F|F|ä¸€è‡´|è¯·æ±‚æ­£å¸¸å®Œæˆäº†|

ä¸Šè¡¨æ•´ç†è‡ªOSTEPç¬”è®°[1]ï¼Œå‡è®¾äº†ä¸€ä¸ªæœ‰dataå’Œinodeã€bitmapä¸¤ç§metadataçš„æ–‡ä»¶ç³»ç»Ÿã€‚å¤šç§metadataä¹‹é—´çš„ä¸€è‡´æ€§é€šå¸¸æœ€éº»çƒ¦ï¼šå¦‚ä¸Šè¡¨çš„inodeå’Œbitmapï¼Œä»–ä»¬ä¹‹é—´å­˜åœ¨ç›¸åŒå†—ä½™ä¿¡æ¯ï¼ˆbitmapå¯ä»¥ä»inodeæ¨å¯¼å‡ºï¼Œä½†æ˜¯è¿™ä¸ªæ¨å¯¼æ˜¯è¦éå†æ‰€æœ‰inodeçš„ï¼Œbitmapçš„ä½œç”¨å°±æ˜¯ç”¨å†—ä½™çš„ä¿¡æ¯æ¢å–æ€§èƒ½ï¼‰ï¼Œå¹¶ä¸”ç”±äºå¹¶éåœ¨ä¸€ä¸ªç£ç›˜å—ï¼Œæ— æ³•åŸå­åœ°åŒæ—¶æ›´æ–°ï¼Œæ‰€ä»¥å¦‚æœæ‰ç”µæ—¶åªæœ‰ä¸¤è€…ä¹‹ä¸€æˆåŠŸæ›´æ–°äº†ï¼Œé‚£ä¹ˆå®ƒä»¬ä¹‹é—´ç›¸åŒçš„ä¿¡æ¯ä¾¿å­˜åœ¨äº†ä¸ä¸€è‡´ã€‚metadataå’Œdataä¹‹é—´ä¹Ÿå­˜åœ¨ä¸ä¸€è‡´çš„æƒ…å†µï¼šå¦‚ä¸Šè¡¨ä¸­ï¼Œè‹¥ä¸¤ç§metadataéƒ½æ›´æ–°å¥½äº†ï¼Œä½†æ˜¯dataå†™åˆ°ä¸€åŠæ‰ç”µäº†ï¼Œé‚£ä¹ˆä¸‹æ¬¡å¼€æœºåæ ¹æ®metadataè¯»dataæ—¶å°±ä¼šè¯»åˆ°åçš„æ•°æ®ï¼Œå› æ­¤å¯ä»¥ç§°ä¸ºä¸ä¸€è‡´ã€‚

è¿™å°±éœ€è¦é¢å¤–çš„æ‰‹æ®µä¿è¯ä¸€è‡´æ€§ï¼Œå¸¸ç”¨çš„æ–¹æ³•æœ‰: WAL(Write ahead logging, ä¹Ÿå«journaling), 
CoW(Copy-on-Write, ä¹Ÿå«shadow paging), log-structuring, 
soft updatesã€‚å½“ç„¶å¯¹äºä¸€ä¸ªå¯¹ä»»ä½•äº‹è¦æ±‚éƒ½å¾ˆä½çš„äººæ¥è¯´ï¼Œåä¸€ç§æƒ…å†µï¼ˆmetadataå’Œdataçš„ä¸ä¸€è‡´ï¼‰å¯èƒ½å¹¶ä¸ç®—ä¸ä¸€è‡´ï¼Œå› ä¸ºæ–‡ä»¶ç³»ç»Ÿæ²¡æœ‰è¢«ç ´åï¼Œè¿˜ä¼šæ­£å¸¸å·¥ä½œï¼Œåªæ˜¯è¢«FSæœåŠ¡çš„ç”¨æˆ·æˆ–åº”ç”¨å¾—åˆ°äº†é”™è¯¯çš„æ•°æ®ï¼Œè°å«ä»–æŠŠç”µçº¿æ‹”äº†å‘¢ğŸ˜‚ã€‚å› æ­¤å¯¹ä¸€è‡´æ€§çš„å®šä¹‰ã€å¯¹ä¸€è‡´æ€§å¼ºå¼±çš„è¦æ±‚ä¹Ÿæ˜¯å› äººè€Œå¼‚ï¼Œå› ç³»ç»Ÿè®¾è®¡ç›®æ ‡è€Œå¼‚ã€‚

æ¯”å¦‚ï¼Œext4ä¾¿æä¾›äº†3ç§loggingæ¨¡å¼ï¼šjournal, ordered(default), writebackï¼Œè¿™ä¸‰ç§æ–¹æ³•å¯¹ä¸€è‡´æ€§çš„å¼ºåº¦ä¾æ¬¡å‡å¼±ï¼Œjournalæ˜¯æŠŠæ‰€æœ‰dataã€metadataå…ˆè¿›è¡Œloggingï¼›orderedæ˜¯ç”¨ordered writeçš„æ–¹æ³•ä¿è¯dataå’Œmetadataçš„ä¸€è‡´æ€§ï¼Œç”¨loggingä¿è¯ä¸åŒç±»åˆ«metadataä¹‹é—´çš„ä¸€è‡´æ€§ï¼Œordered writeæŒ‡ä½†æ˜¯å…ˆå†™dataå®Œæˆï¼Œå†å†™metadataçš„é¡ºåºï¼Œdataå› æ­¤ä¹Ÿä¸ç”¨è¿›è¡Œloggingï¼›writebackåˆ™ä¸ç®¡dataå’Œmetadataçš„å…ˆåé¡ºåºï¼Œdataä¹Ÿä¸å†™logï¼Œå¯èƒ½åˆšåˆšæåˆ°çš„è¦æ±‚å¾ˆä½çš„äººå’Œå¯¹æ€§èƒ½è¦æ±‚æ›´é«˜çš„äººæ‰ä¼šç”¨è¿™ä¸ªå‚æ•°å§ã€‚

```
æ‘˜è‡ªkernelæ–‡æ¡£[2]
data=journal		All data are committed into the journal prior to 
                        being written into the main file system.  Enabling
			this mode will disable delayed allocation and
			O_DIRECT support.

data=ordered	(*)	All data are forced directly out to the main file
			system prior to its metadata being committed to the
			journal.

data=writeback		Data ordering is not preserved, data may be written
			into the main file system after its metadata has been
			committed to the journal.
```



---
[1] http://blog.jcix.top/2018-02-24/ostep_note3/#71_Crash_Consistency

[2] https://www.kernel.org/doc/Documentation/filesystems/ext4.txt

## Journaling

æœ¬wikiçš„[[Log-Structuredã€Copy-on-Writeå’ŒRedirect-on-Write|distri_005]]æ¡ç›®ä»‹ç»äº†logging(journaling)å’Œlog-structingçš„åŒºåˆ«ã€‚

Journaling å³ Write-ahead loggingï¼Œä»¥Ext3æ–‡ä»¶ç³»ç»Ÿä¸ºä¾‹ï¼Œå…¶logæœºåˆ¶å’Œæ•°æ®åº“ä¸­æ‰€è¯´çš„redo logç±»ä¼¼[1]ã€‚å…ˆå†™logï¼Œå†å†™æ•°æ®ï¼Œå¦‚æœå‘ç”Ÿcrashï¼Œæ¢å¤æ—¶redoå³å¯ã€‚é™¤äº†å¯¹metadataå­˜ä¸¤éçš„ext3é»˜è®¤çš„Orderedæ¨¡å¼å¤–ï¼Œè¿˜æ”¯æŒJournalæ¨¡å¼(dataå’Œmetadataéƒ½å­˜ä¸¤é)å’ŒWritebackæ¨¡å¼(åªæœ‰metadataå†™ä¸¤éï¼Œä¸åŒäºOrderedæ¨¡å¼çš„æ˜¯ï¼Œç¬¬äºŒéå†™å®Œæ—¶å¹¶ä¸ä¿è¯dataå·²ç»è½ç›˜ï¼Œè€ŒOrderedæ¨¡å¼ä¸­ï¼Œè¦ç­‰æ•°æ®å—è½ç›˜ä¹‹åå†å°†metadataè½ç›˜)ã€‚

---
[1] https://pdfs.semanticscholar.org/presentation/2d01/803c1c7c21f3e7c4b1a2230b2e78a00d0897.pdf

## Log-structuring

å…¶ç‰¹ç‚¹æ˜¯è¿½åŠ å†™ã€‚æ‰€æœ‰çš„å†™æ“ä½œéƒ½å˜æˆäº†é¡ºåºå†™ï¼Œå¸¦æ¥çš„åæœæ˜¯é¡ºåºè¯»æ“ä½œå¯èƒ½éƒ½å˜æˆéšæœºè¯»äº†ã€‚

## Copy-on-write (shadow paging)

## Soft Updates